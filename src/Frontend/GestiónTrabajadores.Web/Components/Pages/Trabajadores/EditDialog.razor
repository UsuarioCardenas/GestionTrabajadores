@using GestiónTrabajadores.Application.DTOs
@using Microsoft.AspNetCore.Components.Forms

<MudDialog>
    <DialogContent>
        @if (_loading)
        {
            <div class="d-flex justify-center align-center pa-4">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
            </div>
        }
        else if (_model != null)
        {
            <MudForm @ref="_form" @bind-IsValid="@_formIsValid">
                <MudGrid Spacing="2">
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_model.Nombres"
                                      Label="Nombres"
                                      Required="true"
                                      RequiredError="Los nombres son obligatorios"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_model.Apellidos"
                                      Label="Apellidos"
                                      Required="true"
                                      RequiredError="Los apellidos son obligatorios"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudSelect @bind-Value="_model.TipoDocumento"
                                   Label="Tipo de Documento"
                                   Required="true"
                                   Variant="Variant.Outlined"
                                   Margin="Margin.Dense">
                            <MudSelectItem Value="@("DNI")">DNI</MudSelectItem>
                            <MudSelectItem Value="@("CE")">Carnet de Extranjería</MudSelectItem>
                            <MudSelectItem Value="@("Pasaporte")">Pasaporte</MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="_model.NumeroDocumento"
                                      Label="Número de Documento"
                                      Required="true"
                                      RequiredError="El número de documento es obligatorio"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense" />
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudText Typo="Typo.caption" Class="mb-1">Sexo *</MudText>
                        <MudRadioGroup @bind-Value="_sexoSeleccionado" Class="d-flex flex-row">
                            <MudRadio Value="@("M")" Color="Color.Primary" Dense="true">Masculino</MudRadio>
                            <MudRadio Value="@("F")" Color="Color.Secondary" Dense="true">Femenino</MudRadio>
                        </MudRadioGroup>
                    </MudItem>

                    <MudItem xs="12" sm="6">
                        <MudDatePicker @bind-Date="_fechaNacimiento"
                                       Label="Fecha de Nacimiento"
                                       Required="true"
                                       MaxDate="DateTime.Today"
                                       Variant="Variant.Outlined"
                                       Margin="Margin.Dense"
                                       DateFormat="dd/MM/yyyy" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudTextField @bind-Value="_model.Direccion"
                                      Label="Dirección"
                                      Required="true"
                                      RequiredError="La dirección es obligatoria"
                                      Lines="2"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudText Typo="Typo.caption" Class="mb-1">Foto (opcional)</MudText>
                        <MudStack AlignItems="AlignItems.Center" Spacing="2">
                            @if (!string.IsNullOrEmpty(_previewUrl))
                            {
                                <div style="max-width: 200px; max-height: 200px; border-radius: 8px; overflow: hidden; border: 2px solid #ccc;">
                                    <MudImage Src="@_previewUrl" Alt="Preview" Style="max-width: 200px; max-height: 200px; object-fit: contain;" />
                                </div>
                            }
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudFileUpload T="IBrowserFile" Accept=".png,.jpg,.jpeg" FilesChanged="OnFileSelected" MaximumFileCount="1">
                                    <ActivatorContent>
                                        <MudButton Variant="Variant.Outlined"
                                                   Color="Color.Primary"
                                                   StartIcon="@Icons.Material.Filled.CloudUpload"
                                                   Size="Size.Small"
                                                   Disabled="@_uploading">
                                            @if (_uploading)
                                            {
                                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" />
                                                <span>Subiendo...</span>
                                            }
                                            else
                                            {
                                                <span>Cambiar</span>
                                            }
                                        </MudButton>
                                    </ActivatorContent>
                                </MudFileUpload>
                                @if (!string.IsNullOrEmpty(_model.Foto))
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   Color="Color.Error"
                                                   Size="Size.Small"
                                                   OnClick="RemovePhoto" />
                                }
                            </MudStack>
                        </MudStack>
                        @if (!string.IsNullOrEmpty(_uploadError))
                        {
                            <MudText Color="Color.Error" Typo="Typo.caption">@_uploadError</MudText>
                        }
                    </MudItem>

                    @if (!string.IsNullOrEmpty(_serverError))
                    {
                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Error" Dense="true">
                                @_serverError
                            </MudAlert>
                        </MudItem>
                    }
                </MudGrid>
            </MudForm>
        }
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel" Size="Size.Small" Disabled="@(_saving || _uploading)">Cancelar</MudButton>
        <MudButton OnClick="Submit"
                   Variant="Variant.Filled"
                   Color="Color.Warning"
                   Size="Size.Small"
                   Disabled="@(_saving || _loading || _uploading)">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-1" />
            }
            Actualizar
        </MudButton>
    </DialogActions>
</MudDialog>